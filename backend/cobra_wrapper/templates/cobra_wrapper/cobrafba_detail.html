{% extends 'base.html' %}
{% load static %}
{% load cobra_wrapper_tags %}

{% block title %}FBA Result of {{ object }}{% endblock title %}

{% block content %}
    {#    <table>#}
    {#        <tr>#}
    {#            <td>description</td>#}
    {#            <td>{{ object.desc }}</td>#}
    {#        </tr>#}
    {#        <tr>#}
    {#            <td>start_time</td>#}
    {#            <td>{{ object.start_time }}</td>#}
    {#        </tr>#}
    {#        <tr>#}
    {#            <td>model</td>#}
    {#            <td><a href="{% url 'cobra_wrapper:cobramodel_detail' model_pk %}">{{ object.model }}</a></td>#}
    {#        </tr>#}
    {#    </table>#}

    {#    <script src="{% static "javascript/chart.js" %}"></script>#}
    {#    <link href="{% static "css/chart.css" %}" rel="stylesheet">#}
    <script src="{% static "javascript/jquery.min.js" %}"></script>
    {#    <script src="{% static "javascript/util.js" %}"></script>#}

    <div class="container">
        <div class="row my-3">
            <div class="col-3">
                <h3>Description</h3>
                <p>{{ object.desc }}</p>
            </div>
            <div class="col-3">
                <h3>Start Time</h3>
                <p>{{ object.start_time }}</p>
            </div>
            <div class="col-3">
                <h3>Model</h3>
                <p>Click <a href="{% url 'cobra_wrapper:cobramodel_detail' model_pk %}">HERE</a></p>
            </div>
        </div>

        <div class="row my-2">
            <div class="alert alert-info" role="alert">
                Calculating Status: {{ object|check_result_status }}
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table table-bordered table-hover" id="res_table">
                    <thead class="text-center table-active">
                    <tr>
                        <th>Name</th>
                        <th>Fluxes Value</th>
                        <th>Previous Fluxes Value</th>
                        <th>Reduced Costs</th>
                        <th>Previous Reduced Costs</th>
                        <th>Shadow Price</th>
                        <th>Previous Shadow Price</th>
                    </tr>
                    </thead>
                    <tbody id="res_body" class="text-center">

                    </tbody>
                </table>
                <button class="btn btn-info" id="more">More</button>
            </div>
        </div>

        <div class="row my-3">
            <div class="col-12">
                <canvas id="canvas"></canvas>
                <br>
                <button class="btn btn-primary" id="more">More</button>
            </div>
        </div>

        <div class="row">
            <div class="col-6">
                <a href="{% url 'cobra_wrapper:cobrafba_confirm_delete' model_pk object.pk %}" class="btn btn-danger">Delete</a>
            </div>
            <div class="col-6">
                <a href="{% url 'cobra_wrapper:cobrafba_list' model_pk %}" class="btn btn-primary">Return</a>
            </div>
        </div>
    </div>
<script>
        $(document).ready(function () {
            // 获取后端返回的数据, 第零号位置是这次计算的结果， 其他位置是历史记录
            let res_data = [];
            const NOW = 0;
            const PREVIOUS = 1;
            const COLOR = ['table-primary', 'table-secondary', 'table-success',
                        'table-info', 'table-warning', 'table-danger'];

            let labels = [];
            let flux_data = [];
            let reduced_costs_data = [];
            let flux_data_pre = [];
            let reduced_costs_data_pre = [];
            let shadow_prices_data = [];
            let shadow_prices_data_pre = [];

            let url = window.location.href;
            url += 'json';

            $.ajax({
                // url: 'http://127.0.0.1:8080/api/data',
                // api url
                // url: 'http://127.0.0.1:8080/api/data',
                url: url,
                method: 'get',
                success: function (res) {
                    // res_data = JSON.parse(res);
                    res_data = res.results;
                    console.log(res_data);
                    let data_now = res_data[0];
                    console.log(data_now);
                    let len = data_now.fluxes.length;
                    console.log(len);
                    for (let i = 0; i < len; i++) {
                        labels.push(data_now.fluxes[i].name);
                        flux_data.push(data_now.fluxes[i].value);
                        reduced_costs_data.push(data_now.reduced_costs[i].value);
                        shadow_prices_data.push(data_now.shadow_prices[i].value);
                    }
                    if (res_data.length === 2) {
                        let data_pre = res_data[1];
                        for (let i = 0; i < len; i++) {
                            // labels.push(data_now.fluxes[i].name);
                            flux_data_pre.push(data_pre.fluxes[i].value);
                            reduced_costs_data_pre.push(data_pre.reduced_costs[i].value);
                            shadow_prices_data_pre.push(data_pre.shadow_prices[i].value);
                        }
                    }
                    load(Math.floor(30));

                },
                error: function (err) {
                    console.log('error when ajax.');
                    return;
                }
            })

            function load(num) {
                let res_body = $('#res_body');
                let str = '';
                for (let i = 0; i < num; i++) {
                    str += '<tr><td class="table-active">' + labels[i] + '</td>' +
                        '<td class="' + Num2Class(flux_data[i]) + '">' + flux_data[i].toFixed(4) + '</td>' +
                        '<td class="' + Num2Class(flux_data_pre[i]) + '">' + flux_data_pre[i].toFixed(4) + '</td>' +
                        '<td class="' + Num2Class(reduced_costs_data[i]) + '">' + reduced_costs_data[i].toFixed(4) + '</td>' +
                        '<td class="' + Num2Class(reduced_costs_data_pre[i]) + '">' + reduced_costs_data_pre[i].toFixed(4) + '</td>' +
                        '<td class="' + Num2Class(shadow_prices_data[i]) + '">' + shadow_prices_data[i].toFixed(4) + '</td>' +
                        '<td class="' + Num2Class(shadow_prices_data_pre[i]) + '">' + shadow_prices_data_pre[i].toFixed(4) + '</td>' +
                        '</tr>';
                }
                res_body.html(str);
            }

            function Num2Class(num){
                let absnum = Math.abs(num);
                let res = '';
                if(absnum < 1){
                    res = COLOR[0];
                }else if(absnum < 3){
                    res = COLOR[1];
                }else if(absnum < 7){
                    res = COLOR[2];
                }else if(absnum < 13){
                    res = COLOR[3];
                }else if(absnum < 17){
                    res = COLOR[4];
                }else{
                    res = COLOR[5];
                }
                return res;
            }

            function loadAll() {
                load(labels.length);
            }

            $('#more').on('click', loadAll);


        });
    </script>
<<<<<<< HEAD





    {#    <p>Status: {{ object|check_result_status }}</p>#}
    {#    {% if result %}#}
    {#        {% if result.ok %}#}
    {#            <div>{{ result }}</div>#}
    {#        {% else %}#}
    {#            <div>{{ result }}</div>#}
    {#        {% endif %}#}
    {#    {% endif %}#}
    {##}
    {#    <a href="{% url 'cobra_wrapper:cobrafba_confirm_delete' model_pk object.pk %}">Delete</a>#}
    {#    <a href="{% url 'cobra_wrapper:cobrafba_list' model_pk %}">Return</a>#}

=======
{#    <p>Status: {{ object|check_result_status }}</p>#}
{#    {% if result %}#}
{#        {% if result.ok %}#}
{#            <div>{{ result }}</div>#}
{#        {% else %}#}
{#            <div>{{ result }}</div>#}
{#        {% endif %}#}
{#    {% endif %}#}
{##}
{#    <a href="{% url 'cobra_wrapper:cobrafba_confirm_delete' model_pk object.pk %}">Delete</a>#}
{#    <a href="{% url 'cobra_wrapper:cobrafba_list' model_pk %}">Return</a>#}
>>>>>>> 9b6b82aa3fd76a4277d027718323bc1cb915cbd3
{% endblock content %}