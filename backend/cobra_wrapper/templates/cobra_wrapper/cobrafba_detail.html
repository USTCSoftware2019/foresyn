{% extends 'base.html' %}
{% load static %}
{% load cobra_wrapper_tags %}

{% block title %}FBA Result of {{ object }}{% endblock title %}

{% block content %}
    <script src="{% static "javascript/jquery.min.js" %}"></script>

    <style>
        #status {
            margin-left: 1em;
        }
    </style>
    <div class="container">
        <div class="row my-3">
            <div class="col-3">
                <h3>Description</h3>
                <p>{{ object.desc }}</p>
            </div>
            <div class="col-3">
                <h3>Start Time</h3>
                <p>{{ object.start_time }}</p>
            </div>
            <div class="col-3">
                <h3>Model</h3>
                <p>Click <a href="{% url 'cobra_wrapper:cobramodel_detail' model_pk %}">HERE</a></p>
            </div>
        </div>

        <div class="row my-2">
            <div class="alert alert-info" role="alert" id="status">
                Calculating Status: {{ object|check_result_status }}
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div id="coenzyme_table">
                    <h2 class="text-center my-5">Coenzymes</h2>
                    <table class="table table-bordered table-hover">
                        <thead class="text-center table-active">
                        <tr>
                            <th>Name</th>
                            <th>Fluxes Value</th>
                            <th>Previous Fluxes Value</th>
                        </tr>
                        </thead>
                        <tbody id="coenzyme_body" class="text-center">

                        </tbody>
                    </table>
                    <div class="text-center">
                        <button class="btn btn-primary" id="show_coenzyme" style="width:100px;">
                            More
                        </button>
                    </div>
                </div>

                <div id="res_table" class="d-none">
                    <h2 class="text-center my-5">Fluxes & Reduced Costs</h2>
                    <table class="table table-bordered table-hover">
                        <thead class="text-center table-active">
                        <tr>
                            <th>Name</th>
                            <th>Fluxes Value</th>
                            <th>Previous Fluxes Value</th>
                            <th>Reduced Costs</th>
                            <th>Previous Reduced Costs</th>
                        </tr>
                        </thead>
                        <tbody id="res_body" class="text-center">

                        </tbody>
                    </table>
                    <div class="text-center">
                        <button class="btn btn-primary" id="show_fluxes" style="width:100px;">
                            More
                        </button>
                    </div>
                </div>

                <div id="shadow_table" class="d-none">
                    <h2 class="text-center my-5">Shadow Prices</h2>
                    <table class="table table-bordered table-hover">
                        <thead class="text-center table-active">
                        <tr>
                            <th>Name</th>
                            <th>Shadow Prices</th>
                            <th>Previous Shadow Prices</th>
                        </tr>
                        </thead>
                        <tbody id="shadow_body" class="text-center">

                        </tbody>
                    </table>
                    <div class="text-center">
                        <button class="btn btn-primary" id="show_shadow" style="width:100px;">
                            More
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row my-3">
            <div class="col-4 text-center">
                <button class="btn btn-info" id="more">More</button>
            </div>
            <div class="col-4 text-center">
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#fba_delete_model">
                    Delete
                </button>
            </div>
            <div class="col-4 text-center">
                <a href="{% url 'cobra_wrapper:cobrafba_list' model_pk %}" class="btn btn-primary">Return</a>
            </div>
        </div>
    </div>
    {#    <!-- Modal -->#}
    <div class="modal fade" id="fba_delete_model" tabindex="-1" role="dialog" aria-labelledby="fba_delete_model"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Confirm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <form action="{% url 'cobra_wrapper:cobrafba_confirm_delete' model_pk object.pk %}" method="post">
                        {% csrf_token %}
                        <p>Are you sure to delete this FBA?</p>
                        <input type="submit" class="btn btn-danger" value="Delete">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // 获取后端返回的数据, 第零号位置是这次计算的结果， 其他位置是历史记录
            let res_data = [];
            const NOW = 0;
            const PREVIOUS = 1;
            const COLOR = ['table-primary', 'table-secondary', 'table-success',
                'table-info', 'table-warning', 'table-danger'];

            let labels = [];
            let shadow_labels = [];
            let flux_data = [];
            let reduced_costs_data = [];
            let flux_data_pre = [];
            let reduced_costs_data_pre = [];
            let shadow_prices_data = [];
            let shadow_prices_data_pre = [];


            let coenzyme_labels = [];
            let coenzyme_data = [];
            let coenzyme_data_pre = [];

            let url = window.location.href;
            url += 'json';

            $.ajax({
                // url: 'http://127.0.0.1:8080/api/data',
                // api url
                // url: 'http://127.0.0.1:8080/api/data',
                url: url,
                method: 'get',
                success: function (res) {
                    // res_data = JSON.parse(res);
                    if (res.error) {
                        handleError();
                        return;
                    }
                    res_data = res.results;
                    console.log(res_data);
                    let data_now = res_data[0];
                    let len = data_now.fluxes.length;
                    for (let i = 0; i < len; i++) {
                        labels.push(data_now.fluxes[i].name);
                        flux_data.push(data_now.fluxes[i].value);
                        reduced_costs_data.push(data_now.reduced_costs[i].value);
                        // shadow_prices_data.push(data_now.shadow_prices[i].value);
                    }

                    if (res_data.length === 2) {
                        let data_pre = res_data[1];
                        for (let i = 0; i < len; i++) {
                            // labels.push(data_now.fluxes[i].name);
                            flux_data_pre.push(data_pre.fluxes[i].value);
                            reduced_costs_data_pre.push(data_pre.reduced_costs[i].value);
                            // shadow_prices_data_pre.push(data_pre.shadow_prices[i].value);
                        }
                    }
                    len = data_now.shadow_prices.length;
                    for (let i = 0; i < len; i++) {
                        shadow_labels.push(data_now.shadow_prices[i].name);
                        shadow_prices_data.push(data_now.shadow_prices[i].value);
                    }

                    if (res_data.length === 2) {
                        let data_pre = res_data[1];
                        for (let i = 0; i < len; i++) {
                            shadow_prices_data_pre.push(data_pre.shadow_prices[i].value);
                        }
                    }

                    console.log(data_now);
                    len = data_now.coenzyme.length;
                    for (let i = 0; i < len; i++) {
                        coenzyme_labels.push(data_now.coenzyme[i].name);
                        coenzyme_data.push(data_now.coenzyme[i].value);
                    }

                    if (res_data.length === 2) {
                        let data_pre = res_data[1];
                        for (let i = 0; i < len; i++) {
                            coenzyme_data_pre.push(data_pre.coenzyme[i].value);
                        }
                    }

                    loadCoenzyme(len);

                    // load(Math.floor(30));

                },
                error: function (err) {
                    console.log('error when ajax.');
                    return;
                }
            });

            function handleError() {
                $('#status').html('Calculating Status: Failed!')
                    .removeClass('alert-info')
                    .addClass('alert-danger');
                $('#res_table').css('display', 'none');
            }

            function loadCoenzyme(num = coenzyme_labels.length) {
                let coenzyme_body = $('#coenzyme_body');
                let str = '';
                if (res_data.length === 2) {
                    for (let i = 0; i < num; i++) {
                        str += '<tr><td class="table-active">' + coenzyme_labels[i] + '</td>' +
                            '<td class="' + Num2Class(coenzyme_data[i]) + '">' + coenzyme_data[i].toFixed(4) + '</td>' +
                            '<td class="' + Num2Class(coenzyme_data_pre[i]) + '">' + coenzyme_data_pre[i].toFixed(4) + '</td>' +
                            '</tr>';
                    }
                } else {
                    for (let i = 0; i < num; i++) {
                        str += '<tr><td class="table-active">' + coenzyme_labels[i] + '</td>' +
                            '<td class="' + Num2Class(coenzyme_data[i]) + '">' + coenzyme_data[i].toFixed(4) + '</td>' +
                            '<td class="' + 'table-active' + '">' + 'None' + '</td>' +
                            '</tr>';
                    }
                }
                coenzyme_body.html(str);
            }

            function load(num = labels.length) {
                let res_body = $('#res_body');
                let str = '';
                if (res_data.length === 2) {
                    for (let i = 0; i < num; i++) {
                        str += '<tr><td class="table-active">' + labels[i] + '</td>' +
                            '<td class="' + Num2Class(flux_data[i]) + '">' + flux_data[i].toFixed(4) + '</td>' +
                            '<td class="' + Num2Class(flux_data_pre[i]) + '">' + flux_data_pre[i].toFixed(4) + '</td>' +
                            '<td class="' + Num2Class(reduced_costs_data[i]) + '">' + reduced_costs_data[i].toFixed(4) + '</td>' +
                            '<td class="' + Num2Class(reduced_costs_data_pre[i]) + '">' + reduced_costs_data_pre[i].toFixed(4) + '</td>' +
                            '</tr>';
                    }
                } else {
                    for (let i = 0; i < num; i++) {
                        str += '<tr><td class="table-active">' + labels[i] + '</td>' +
                            '<td class="' + Num2Class(flux_data[i]) + '">' + flux_data[i].toFixed(4) + '</td>' +
                            '<td class="' + 'table-active' + '">' + 'None' + '</td>' +
                            '<td class="' + Num2Class(reduced_costs_data[i]) + '">' + reduced_costs_data[i].toFixed(4) + '</td>' +
                            '<td class="' + 'table-active' + '">' + 'None' + '</td>' +
                            '</tr>';
                    }
                }
                $('#res_table').removeClass('d-none');
                res_body.html(str);
            }

            function Num2Class(num) {
                let absnum = Math.abs(num);
                let res = '';
                if (absnum < 1) {
                    res = COLOR[0];
                } else if (absnum < 3) {
                    res = COLOR[1];
                } else if (absnum < 7) {
                    res = COLOR[2];
                } else if (absnum < 13) {
                    res = COLOR[3];
                } else if (absnum < 17) {
                    res = COLOR[4];
                } else {
                    res = COLOR[5];
                }
                return res;
            }

            function loadAll() {
                load(labels.length);
                loadShadowPrices();
            }

            function loadShadowPrices(num = shadow_labels.length) {
                let len = shadow_labels.length;
                let res_body = $('#shadow_body');
                let str = '';
                if (res_data.length === 2) {
                    for (let i = 0; i < len; i++) {
                        str += '<tr><td class="table-active">' + shadow_labels[i] + '</td>' +
                            '<td class="' + Num2Class(shadow_prices_data[i]) + '">' + shadow_prices_data[i].toFixed(4) + '</td>' +
                            '<td class="' + Num2Class(shadow_prices_data_pre[i]) + '">' + shadow_prices_data_pre[i].toFixed(4) + '</td>' +
                            '</tr>';
                    }
                } else {
                    for (let i = 0; i < len; i++) {
                        str += '<tr><td class="table-active">' + shadow_labels[i] + '</td>' +
                            '<td class="' + Num2Class(shadow_prices_data[i]) + '">' + shadow_prices_data[i].toFixed(4) + '</td>' +
                            '<td class="' + 'table-active' + '">' + 'None' + '</td>' +
                            '</tr>';
                    }
                }
                $('#shadow_table').removeClass('d-none');
                res_body.html(str);
            }

            $('#more').on('click', loadAll);

            $('#show_coenzyme').on('click', function () {
                loadCoenzyme(coenzyme_labels.length);
                $(this).addClass('btn-secondary');
            });

            $('#show_fluxes').on('click', function () {
                load(labels.length);
                $(this).addClass('btn-secondary');
            });

            $('#show_shadow').on('click', function () {
                loadShadowPrices(shadow_labels.length);
                $(this).addClass('btn-secondary');
            });
        });
    </script>

{% endblock content %}